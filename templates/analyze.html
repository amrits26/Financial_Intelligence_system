{% extends "base.html" %}
{% block content %}
<h1>Stock Analysis</h1>

<div class="card mt-3">
  <div class="card-body">
    <form method="POST" action="{{ url_for('analyze') }}">
      <div class="row g-2">
        <div class="col-md-5">
          <label class="form-label">Stock Symbol</label>
          <input type="text" class="form-control" name="symbol" value="{{ symbol or '' }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Period</label>
          <select class="form-select" name="period">
            <option value="1y" {% if period=='1y' %}selected{% endif %}>1 Year</option>
            <option value="2y" {% if period=='2y' %}selected{% endif %}>2 Years</option>
            <option value="6mo" {% if period=='6mo' %}selected{% endif %}>6 Months</option>
            <option value="3mo" {% if period=='3mo' %}selected{% endif %}>3 Months</option>
          </select>
        </div>
        <div class="col-md-2 align-self-end">
          <button type="submit" class="btn btn-primary w-100">Analyze</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% if result %}
<div class="mt-4">

  <!-- Recommendation & Confidence -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>ğŸš€ Recommendation:
        <span class="badge bg-{{ 'success' if result.recommendation=='buy' else 'danger' if result.recommendation=='sell' else 'secondary' }}">
          {{ result.recommendation|upper }}
        </span>
      </h5>
      <p>Confidence: <strong>{{ "%.0f"|format(result.confidence*100) }}%</strong></p>
    </div>
  </div>

  <!-- AI Summary -->
  {% if result.llm_summary %}
  <div class="card mb-4 border-primary">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="fas fa-robot text-primary"></i> AI Summary</h6>
    </div>
    <div class="card-body">
      <p>{{ result.llm_summary }}</p>
    </div>
  </div>
  {% endif %}

  <!-- Candlestick Chart -->
  <!-- {% if result.chart_data and result.chart_data.open %}
  <div class="card mb-4" style="overflow-x:auto;">
    <div class="card-header"><h6 class="mb-0">ğŸ•¯ï¸ Candlestick Chart</h6></div>
    <div class="card-body" style="min-width:1200px; height:500px;">
      <canvas id="candleChart"></canvas>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
      <script>
        const cd = {{ result.chart_data|tojson }};
        const candleData = cd.dates.map((d,i) => ({
          x: d, o: cd.open[i], h: cd.high[i], l: cd.low[i], c: cd.close[i]
        }));
        new Chart(
          document.getElementById('candleChart').getContext('2d'),
          {
            type: 'candlestick',
            data: { datasets: [{ label: '{{ symbol }}', data: candleData }] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  type: 'time',
                  time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' },
                  title: { display: true, text: 'Date' },
                  ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 20 }
                },
                y: {
                  title: { display: true, text: 'Price (USD)' }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: ctx => 
                      `O:${ctx.raw.o.toFixed(2)} H:${ctx.raw.h.toFixed(2)} ` +
                      `L:${ctx.raw.l.toFixed(2)} C:${ctx.raw.c.toFixed(2)}`
                  }
                }
              }
            }
          }
        );
      </script>
    </div>
  </div>
  {% endif %} -->

  <!-- Sentiment Analysis -->
  {% set s = result.agent_results.sentiment %}
  <div class="card mb-4">
    <div class="card-header"><h6 class="mb-0">ğŸ’¬ Market Sentiment ({{ s.articles_analyzed }} articles)</h6></div>
    <div class="card-body text-center">
      <h3 class="text-{{ 'success' if s.overall_sentiment=='positive' else 'danger' if s.overall_sentiment=='negative' else 'secondary' }}">
        {% if s.overall_sentiment=='positive' %}ğŸ˜Š Positive{% elif s.overall_sentiment=='negative' %}ğŸ˜Ÿ Negative{% else %}ğŸ˜ Neutral{% endif %}
      </h3>
      <div class="row mt-3">
        <div class="col"><strong class="text-success">{{ s.distribution.positive }}</strong><br>Positive</div>
        <div class="col"><strong class="text-secondary">{{ s.distribution.neutral }}</strong><br>Neutral</div>
        <div class="col"><strong class="text-danger">{{ s.distribution.negative }}</strong><br>Negative</div>
      </div>
    </div>
  </div>

  <!-- Risk Assessment -->
  {% set r = result.agent_results.risk %}
  <div class="card mb-4">
    <div class="card-header"><h6 class="mb-0">âš ï¸ Risk Assessment</h6></div>
    <div class="card-body text-center">
      <h3 class="text-{{ 'success' if r.risk_level=='Low' else 'warning' if r.risk_level=='Medium' else 'danger' }}">
        {{ r.risk_level }} Risk
      </h3>
      <p>Volatility: {{ "%.2f"|format(r.volatility*100) }}%</p>
      <p>VaR (95%): {{ "%.2f"|format(r.var_95*100) }}%</p>
    </div>
  </div>

  <!-- Technical Details -->
  <div class="accordion mb-4" id="rawData">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRaw">
          ğŸ”§ Technical Details
        </button>
      </h2>
      <div id="collapseRaw" class="accordion-collapse collapse" data-bs-parent="#rawData">
        <div class="accordion-body">
          <pre class="bg-light p-3" style="max-height:400px; overflow:auto;">{{ result | tojson(indent=2) }}</pre>
        </div>
      </div>
    </div>
  </div>

</div>
{% endif %}
{% endblock %}
